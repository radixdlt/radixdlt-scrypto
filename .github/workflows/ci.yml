name: CI

on:
  push:
    branches:
      - main
      - develop
      - docs
      - alphanet
      - betanet
      - release/*
  pull_request:
    branches:
      - main
      - develop
      - docs
      - alphanet
      - betanet
      - release/*

env:
  CARGO_TERM_COLOR: always

jobs:
  cancel_running_workflows:
    name: Cancel running workflows
    runs-on: ubuntu-20.04
    steps:
      - name: cancel running workflows
        uses: styfle/cancel-workflow-action@0.8.0
        with:
          access_token: ${{ github.token }}
  simulator:
    name: Run CLI tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [linux, windows-latest]
    steps:
    - uses: actions/checkout@v3
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
    - run: |
        echo HOME=$HOME

    - uses: lrubaszewski/rust-cache@dont_clean_registry_src
      with:
        key: with_registry_src
        cache-directories:
          ~/.cargo/registry/src/**/librocksdb-sys-*
        workspaces: simulator

    - run: |
        sudo apt-get update -qq
        sudo apt-get install clang cmake m4 -y
      if: matrix.os == 'linux'
    - name: Add wasm target
      run: rustup target add wasm32-unknown-unknown
    - name: Set LIBCLANG_PATH # See https://github.com/rust-lang/rust-bindgen/issues/1797
      if: runner.os == 'Windows'
      run: echo "LIBCLANG_PATH=$((gcm clang).source -replace "clang.exe")" >> $env:GITHUB_ENV
    - name: Install dependencies
      if: runner.os == 'Windows'
      run: choco install llvm -y
    - name: Run tests
      run: bash ./tests/resim.sh
      working-directory: simulator
    - name: Run tests
      run: bash ./tests/manifest.sh
      working-directory: simulator
    - name: Run tests
      run: bash ./tests/scrypto.sh
      working-directory: simulator
    - uses: actions/upload-artifact@v3
      with:
        name: artifact-${{ matrix.os }}
        path: simulator/target/cargo-timings/timings_*.html
