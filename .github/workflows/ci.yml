name: CI

on:
  push:
    branches:
      - main
      - develop
      - docs
      - alphanet
      - betanet
      - release/*
  pull_request:
    branches:
      - main
      - develop
      - docs
      - alphanet
      - betanet
      - release/*

env:
  CARGO_TERM_COLOR: always

jobs:
  cancel_running_workflows:
    name: Cancel running workflows
    runs-on: ubuntu-20.04
    steps:
      - name: cancel running workflows
        uses: styfle/cancel-workflow-action@0.8.0
        with:
          access_token: ${{ github.token }}
  simulator:
    name: Run CLI tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [linux, windows-latest]
    steps:
    - uses: actions/checkout@v3
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
    - run: |
        echo HOME=$HOME

    - name: Setup Sccache for Rust compilation
      uses: metalbear-co/sccache-action@17192d82c6c41cc16d4e06b7681ab1b452690206
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        cache-from: sccache-${{ runner.os }}-
        cache-to: sccache-${{ runner.os }}-${{ github.sha }}

    - name: Setup rust-cache to reduce build time
      uses: lrubaszewski/rust-cache@allow_registry_src_caching
      with:
        key: cache-${{ runner.os }}
        cache-directories:
          ~/.cargo/registry/src/**/librocksdb-sys-*
        workspaces: sbor

    - run: |
        sudo apt-get update -qq
        sudo apt-get install clang cmake m4 -y
      if: matrix.os == 'linux'
    - name: Add wasm target
      run: rustup target add wasm32-unknown-unknown
    - name: Set LIBCLANG_PATH # See https://github.com/rust-lang/rust-bindgen/issues/1797
      if: runner.os == 'Windows'
      run: echo "LIBCLANG_PATH=$((gcm clang).source -replace "clang.exe")" >> $env:GITHUB_ENV
    - name: Install dependencies
      if: runner.os == 'Windows'
      run: choco install llvm -y

    - name: cargo test -p sbor
      run: cargo test -p sbor
      working-directory: .

        #    - name: Run tests
        #      run: bash ./tests/resim.sh
        #      working-directory: simulator
        #    - name: Run tests
        #      run: bash ./tests/manifest.sh
        #      working-directory: simulator
        #
        #    - name: Run tests
        #      run: bash ./tests/scrypto.sh
        #      working-directory: simulator
    - uses: actions/upload-artifact@v3
      with:
        name: artifact-${{ matrix.os }}
        path: simulator/target/cargo-timings/timings_*.html
